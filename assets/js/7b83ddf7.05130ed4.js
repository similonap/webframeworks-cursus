"use strict";(self.webpackChunkwebframeworks_cursus=self.webpackChunkwebframeworks_cursus||[]).push([[9046],{28061:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"wf-course/labs/nextjs/lab5/README","title":"Labo 5","description":"1. Herhalingsoefening: Spotifi","source":"@site/docs/wf-course/labs/nextjs/lab5/README.md","sourceDirName":"wf-course/labs/nextjs/lab5","slug":"/wf-course/labs/nextjs/lab5/","permalink":"/webframeworks-cursus/wf-course/labs/nextjs/lab5/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"wfCourse","previous":{"title":"Labo 4","permalink":"/webframeworks-cursus/wf-course/labs/nextjs/lab4/"},"next":{"title":"Projecten","permalink":"/webframeworks-cursus/wf-course/opdrachten/"}}');var o=s(74848),r=s(28453);const i={},a="Labo 5",l={},c=[{value:"1. Herhalingsoefening: Spotifi",id:"1-herhalingsoefening-spotifi",level:2}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"labo-5",children:"Labo 5"})}),"\n",(0,o.jsx)(e.h2,{id:"1-herhalingsoefening-spotifi",children:"1. Herhalingsoefening: Spotifi"}),"\n",(0,o.jsxs)(e.blockquote,{children:["\n",(0,o.jsxs)(e.p,{children:["\ud83d\udcc2 ",(0,o.jsx)(e.strong,{children:"Naam project:"})," ",(0,o.jsx)(e.code,{children:"lab-nextjs-spotifi"}),"\n\ud83d\udd17 ",(0,o.jsx)(e.strong,{children:"Basis project:"})]}),"\n"]}),"\n",(0,o.jsxs)(e.p,{children:["We gaan een eigen versie van een muziekstreamingdienst bouwen, genaamd Spotifi. We gaan hiervoor de volgende REST API gebruiken: ",(0,o.jsx)(e.a,{href:"https://sampleapis.assimilate.be/music/songs",children:"Music REST API"}),"."]}),"\n",(0,o.jsxs)(e.p,{children:["Om hier sneller mee aan de slag te kunnen, kan je best beginnen van de ",(0,o.jsx)(e.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:s(94333).A+"",children:"static-html"})," zip file. Dit is een statische HTML versie van de Spotifi app."]}),"\n",(0,o.jsxs)(e.p,{children:["Je kan een volledig werkende versie van het project uitproberen op ",(0,o.jsx)(e.a,{href:"https://spotifi-next-js.vercel.app/",children:"https://spotifi-next-js.vercel.app/"}),"."]}),"\n",(0,o.jsx)(e.p,{children:"Je kan ook vertrekken van de volgende database bestanden:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'// file: database/auth.ts\nimport { Collection, MongoClient } from "mongodb";\nimport { User } from "@/types"\n\nconst client = new MongoClient(process.env.MONGODB_URI!);\n\nexport const userCollection: Collection<User> = client.db("spotifi").collection<User>("users");\n\nexport const findUserByEmail = async (email: string): Promise<User | null> => {\n    return await userCollection.findOne<User>({ email });\n}\n\nexport const findUserById = async (id: number): Promise<User | null> => {\n    return await userCollection.findOne<User>({id});\n}\n\nexport const createUser = async (user: Omit<User, "id">): Promise<void> => {\n    const lastUser = await userCollection.find().sort({ id: -1 }).limit(1).toArray();\n    const newId = lastUser.length > 0 ? lastUser[0].id + 1 : 1;\n    const userWithId: User = { id: newId, ...user };\n    await userCollection.insertOne(userWithId);\n}\n\nexport const updateUser = async (id: number, updates: Partial<User>): Promise<void> => {\n    await userCollection.updateOne({ id }, { $set: updates });\n}\n'})}),"\n",(0,o.jsx)(e.p,{children:"en"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:"// file: database/songs.ts\nimport { Collection, MongoClient, SortDirection } from \"mongodb\";\nimport { Song, SortField, User } from \"@/types\"\n\nexport const PAGE_SIZE = 10;\n\nconst client = new MongoClient(process.env.MONGODB_URI!);\n\nexport const songsCollection: Collection<Song> = client.db(\"spotifi\").collection<Song>(\"songs\");\nexport const usersCollection: Collection<User> = client.db(\"spotifi\").collection<User>(\"users\");\n\nexport const seedSongs = async () => {\n\n    const response = await fetch(\"https://sampleapis.assimilate.be/music/songs\");\n    const data: Song[] = await response.json();\n\n    let songs: Song[] = data;\n    await songsCollection.deleteMany({});\n    if (await songsCollection.countDocuments() === 0) {\n        songsCollection.insertMany(songs);\n        console.log(\"Seeded songs collection\");\n    }\n    console.log(\"Songs collection seeded!\");\n}\n\nexport const getSongs = async (\n  userId: number | null, \n  q: string, \n  sortField: SortField, \n  sortDirection: SortDirection, \n  page: number = 1\n) => { \n    const pipeline: any[] = [];\n\n    if (q) {\n        const regex = new RegExp(q, 'i');\n        pipeline.push({\n            $match: {\n                $or: [\n                    { title: { $regex: regex } },\n                    { description: { $regex: regex } },\n                ],\n            },\n        });\n    }\n\n    if (userId != null) {\n        pipeline.push(\n            {\n                $lookup: {\n                    from: 'users',\n                    let: { songId: '$id' },\n                    pipeline: [\n                        { $match: { $expr: { $eq: ['$id', userId] } } },\n                        { $project: { _id: 0, library: 1 } },\n                    ],\n                    as: 'user_ctx',\n                },\n            },\n            { $addFields: { owned: { $in: ['$id', { $ifNull: [{ $arrayElemAt: ['$user_ctx.library', 0] }, []] }] } } },\n            { $project: { user_ctx: 0 } }\n        );\n    }\n\n    if (sortField === 'publish_date') {\n        pipeline.push({ $sort: { 'more_information.publish_date': sortDirection === 'asc' ? -1 : 1 } });\n    } else if (sortField === 'title') {\n        pipeline.push({ $sort: { title: sortDirection === 'asc' ? 1 : -1 } });\n    } else if (sortField === 'owned' && userId != null) {\n        pipeline.push({ $sort: { owned: sortDirection === 'asc' ? -1 : 1 } });\n    }\n\n    pipeline.push({\n        $facet: {\n            data: [\n                { $skip: (page - 1) * PAGE_SIZE },\n                { $limit: PAGE_SIZE }\n            ],\n            totalCount: [\n                { $count: 'count' }\n            ]\n        }\n    });\n\n    const [result] = await songsCollection.aggregate(pipeline).toArray();\n\n    const songs = result.data;\n    const total = result.totalCount[0] ? result.totalCount[0].count : 0;\n\n    return {\n        songs: makeLean<Song[]>(songs),\n        pages: Math.ceil(total / PAGE_SIZE)\n    };\n}\n\nexport const getSongById = async (songId: number, userId: number | null = null): Promise<Song | null> => {\n    const pipeline: any[] = [\n        { $match: { id: songId } }\n    ];\n\n    if (userId != null) {\n        pipeline.push(\n            {\n                $lookup: {\n                    from: 'users',\n                    let: { songId: '$id' },\n                    pipeline: [\n                        { $match: { $expr: { $eq: ['$id', userId] } } },\n                        { $project: { _id: 0, library: 1 } },\n                    ],\n                    as: 'user_ctx',\n                },\n            },\n            { $addFields: { owned: { $in: ['$id', { $ifNull: [{ $arrayElemAt: ['$user_ctx.library', 0] }, []] }] } } },\n            { $project: { user_ctx: 0 } }\n        );\n    }\n\n    const [song] = await songsCollection.aggregate<Song>(pipeline).toArray();\n    return song ? makeLean<Song>(song) : null;\n}\n\nconst makeLean = <T,>(obj: any): T => {\n    return JSON.parse(JSON.stringify(obj)) as T;\n}\n\nexport const addCoinsToUser = async (userId: number, coins: number): Promise<void> => {\n    await usersCollection.updateOne({ id: userId }, { $inc: { credits: coins } });\n}\n"})}),"\n",(0,o.jsx)(e.p,{children:"en de volgende interfaces:"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-ts",children:'// file: types.ts\nexport interface User {\n    id: number;\n    email: string;\n    name: string;\n    credits: number;\n    avatar: string;\n    passwordHash: string;\n    library: number[];\n}\n\n\nexport interface Song {\n    id: number;\n    title: string;\n    description: string;\n    thumbnail: string;\n    credits: number;\n    mp3: string;\n    owned?: boolean;\n    more_information: {\n        publish_date: string;\n        genre: string;\n        type: string;\n        youtube?: string;\n    };\n}\n\n\nexport type SortField = "title" | "owned" | "publish_date";\nexport type SortDirection = "asc" | "desc";\n'})})]})}function p(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(d,{...n})}):d(n)}},28453:(n,e,s)=>{s.d(e,{R:()=>i,x:()=>a});var t=s(96540);const o={},r=t.createContext(o);function i(n){const e=t.useContext(r);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:i(n.components),t.createElement(r.Provider,{value:e},n.children)}},94333:(n,e,s)=>{s.d(e,{A:()=>t});const t=s.p+"assets/files/static-html-032bc6fe6566fb2c828e23e8b464128c.zip"}}]);